{extend name="public/base" /}
{block name="body"}
<div class="form">
    <form class="layui-form" action="" method="post" />
    <input value="{$orgdata['id']}" id="id_id" type="hidden" name="id" />
    <dl class="layui-form-item">
        <dt class="layui-form-label">机构编号：</dt>
        <dd class="layui-input-inline"><input readonly="" class="input layui-input" type="text" name="org_code" id="titleenname" value="{$orgdata['org_code']}" placeholder="机构编号" /></dd>
    </dl>
    <dl class="layui-form-item">
        <dt class="layui-form-label">机构名称：</dt>
        <dd class="layui-input-inline"><input readonly="" class="input layui-input" type="text" name="name" id="titlename" value="{$orgdata['name']}" placeholder="机构名称" /></dd>
    </dl>

    <dl class="layui-form-item">
        <dt class="layui-form-label">机构上级机构名：</dt>
        <dd class="layui-input-inline">
            <input readonly="" class="input layui-input" type="text" name="pname" id="titlename" value="{$pname}" placeholder="机构名称" readonly="readonly" />
        </dd>
    </dl>
    <dl class="layui-form-item">
        <dt class="layui-form-label">是否有下级机构：</dt>
        <dd class="layui-input-inline">
            <input {eq name="$orgdata['haschild']" value="1"} checked="checked"{/eq} type="radio" name="haschild" value="1" title="是">
            <input {eq name="$orgdata['haschild']" value="0"} checked="checked"{/eq} type="radio" name="haschild" value="0" title="否">
        </dd>
    </dl>
    <dl class="layui-form-item">
        <dt class="layui-form-label">机构级别：</dt>
        <dd class="layui-input-inline">
            <select lay-filter="orgtype" lay-verify="requiredorgtype" class="select orgtype" name="type" id="type">
                {volist name="org_type_list" id="vo"}
                <option value="{$key}" {if $orgdata['type'] == $key} selected {/if}>{$vo}</option>
                {/volist}
            </select>
        </dd>
    </dl>
    <dl class="layui-form-item">
        <dt class="layui-form-label">机构简介：</dt>
        <dd class="layui-input-block">
            <script type="text/plain" name="summary" id="summary">{$orgdata['summary']}</script>
            <div class="picbox">
                <div class="add_pic_div">
                    <div class="filesbtn">上传图片</div>
                    <input id="summarypic" type="hidden" class="input" name="summarypic" value="{$orgdata['summarypic']}" />
                </div>
            </div>
        </dd>
    </dl>
    <div class="village" style="display: none;">
        <dl class="layui-form-item">
            <dt class="layui-form-label">经济发展情况：</dt>
            <dd class="layui-input-block">
                <script type="text/plain" name="econdevelopment" id="econdevelopment">{$orgdata['econdevelopment']}</script>
                <div class="picbox">
                    <div class="add_pic_div">
                        <div class="filesbtn">上传图片</div>
                        <input id="econdevelopmentpic" type="hidden" class="input" name="econdevelopmentpic" value="{$orgdata['econdevelopmentpic']}" />
                    </div>
                </div>
            </dd>
        </dl>
        <dl class="layui-form-item">
            <dt class="layui-form-label">资源优势情况：</dt>
            <dd class="layui-input-block">
                <script type="text/plain" name="resosuperiority" id="resosuperiority">{$orgdata['resosuperiority']}</script>
                <div class="picbox">
                    <div class="add_pic_div">
                        <div class="filesbtn">上传图片</div>
                        <input id="resosuperioritypic" type="hidden" class="input" name="resosuperioritypic" value="{$orgdata['resosuperioritypic']}" />
                    </div>
                </div>
            </dd>
        </dl>
    </div>
    <div class="district">
        <!-- 区 -->
        <div class="con">
           <!--  {volist name="msgmodulelist" id="vo" key="index"}
            <fieldset class="layui-elem-field" data-index="{$index-1}">
                <legend>区/乡镇级信息模块</legend>
                <div class="layui-field-box">
                    <div class="layui-form-item">
                        <label class="layui-form-label">信息题目：</label>
                        <div class="layui-input-block">
                            <input lay-verify="required" type="text" value="{$vo['district_title']}" name="msgmodule[{$index-1}][district_title]" placeholder="信息题目" class="layui-input title">
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <label class="layui-form-label">信息内容：</label>
                        <div class="layui-input-block">
                            <script class="con" type="text/plain" name="msgmodule[{$index-1}][districtcon]" id="district_{$index-1}"></script>
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <label class="layui-form-label">汇报页展示模板：</label>
                        <div class="layui-input-inline">
                            <select lay-verify="required" class="muban" name="msgmodule[{$index-1}][muban]" lay-filter="muban">
                                {volist name=":config('huibaomuban')" id="val"}
                                    <option {if $vo['muban'] == $key} selected {/if} value="{$key}">{$val}</option>
                                {/volist}
                            </select>
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <label class="layui-form-label">上传图片：</label>
                        <div class="layui-input-block">
                            <div class="picbox">
                                <div class="add_pic_div">
                                    <div class="filesbtn">上传图片</div>
                                    <input type="hidden" class="input pichidden" name="msgmodule[{$index-1}][district_pic]" value="{$vo['district_pic']}" />
                                    <div class="layui-btn layui-btn-primary destroy">销毁</div> 
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </fieldset>
            {/volist} -->
        </div>
      <!--   <div class="btn-list">
            <div class="layui-btn addproject">添加信息项目</div>
            <div class="layui-btn delproject">删除信息项目</div>
        </div> -->
    </div>
    <dl class="layui-form-item">
        <dt class="left"></dt>
        <dd class="right">
             {:get_link_info('admin', 'organizationCon', 'edit', array(), '提交', array('lay-submit' => '', 'lay-filter' => "submitbt", 'class' => "submitbt layui-btn layui-btn-normal", 'type' => "", 'name' => "bt", 'id' => "bt"), 'button')}
         </dd>
    </dl>
    <input type="hidden" name="pid" id="pid" value="{$orgdata['pid']}" />
    </form>
</div>

{/block}
{block name="foot-js"}
<script type="text/javascript">
    $(document).ready(function(){
        var editorArr = [];//区/乡镇级信息模块编辑器对象容器
        // 表单验证
        layui.use(['form','layer'], function(){
            var form = layui.form;
            var layer = layui.layer;
            form.render();

            form.on('select(jigou)', function (data) {
                var clickpid = $(data.elem).attr("id");
                var select = '<select lay-filter="jigou" class="select" name="pid1" id="enCode_{replace}"><option value="" selected="selected">请选择</option></select>';
                if (data.value) {
                    $("#pid").val(data.value);
                }
                $.post('{:get_link_info('admin', 'organizationCon', 'jsnextOrg')}', {'code':data.value}, function(data){
                    if (data.state == 'success') {
                        $("#" + clickpid).nextAll().remove();
                        $("#" + clickpid).parent().append(select.replace('{replace}', clickpid));
                        var html = '';
                        for(var i=0;i<data.data.length;i++){
                            html += '<option value="' + data.data[i].id + '">'+data.data[i].name+'</option>';
                        }
                        $("#" + clickpid).next().append(html);
                        form.render('select');
                    }
                });
            });

            /* 初始化机构级别 */
       /*     function initOrgtype(val){
                if (val === '7') {
                    $(".village").fadeIn();
                    $(".district").find('input[lay-verify="required"], select[lay-verify="required"]').attr('lay-verify', '');
                } else {
                    $(".village").fadeOut();
                }
                if (val === '5' || val === '6') {
                    $(".district").fadeIn();
                    $(".district").find('input[lay-verify=""], select[lay-verify=""]').attr('lay-verify', 'required');
                } else {
                    $(".district").fadeOut();
                }
            }
            initOrgtype($("select.orgtype").val());
            form.on('select(orgtype)', function(data){
                initOrgtype(data.value);
            });*/
            form.on('submit(submitbt)', function (data) {
                $("form.layui-form").submit();
                // console.log(data.field);
                return false;
            });

            $("div.form").on('click', '.filesbtn', function(){
                mytools.fnFilesUploadCPM(this, $(this).next('input'), "__UPLOAD__", "{:url('admin/Ajax/uploadFiles')}");
            });
      /*      $("div.form").on('click', '.destroy', function(){
                console.log($(this).parents('.layui-elem-field').find('.con'));
            });*/

            // 添加信息项目
    /*        $("div.form").on('click', '.addproject', function(){
                var field = $(this).parent().prev().find('.layui-elem-field').last();
                var index = (function(){
                    if (field.last().length) {
                        return parseInt( field.last().data('index') ) + 1;
                    } else {
                        return 0;
                    }
                })();
                var item = '<fieldset class="layui-elem-field additem" data-index='+index+'><legend>区/乡镇级信息模块</legend><div class="layui-field-box"><div class="layui-form-item"><label class="layui-form-label">信息题目：</label><div class="layui-input-block"><input lay-verify="required" type="text" name="msgmodule['+index+'][district_title]" placeholder="信息题目" class="layui-input title"></div></div><div class="layui-form-item"><label class="layui-form-label">信息内容：</label><div class="layui-input-block"><script class="con" type="text/plain" name="msgmodule['+index+'][districtcon]" id="district_'+index+'"><\/script></div></div><div class="layui-form-item"><label class="layui-form-label">汇报页展示模板：</label><div class="layui-input-inline"><select lay-verify="required" class="muban" name="msgmodule['+index+'][muban]" lay-filter="muban">{volist name=":config('huibaomuban')" id="vo"}<option value="{$key}">{$vo}</option>{/volist}</select></div></div><div class="layui-form-item"><label class="layui-form-label">上传图片：</label><div class="layui-input-block"><div class="picbox"><div class="add_pic_div"><div class="filesbtn">上传图片</div><input type="hidden" class="input pichidden" name="msgmodule['+index+'][district_pic]" value="" /><!-- <div class="layui-btn layui-btn-primary destroy">销毁</div> --></div></div></div></div></div></fieldset>';
                $(this).parent().prev().append(item);
                form.render('select');
                editorArr.push( {
                    editor: UE.getEditor('district_'+index),
                    dom: 'district_'+index
                } );
            });
            // 删除信息项目
            $("div.form").on('click', '.delproject', function(){
                var item = $(this).parent().prev().find('.layui-elem-field');
                var index = item.eq(item.length-1).data('index');
                if (item.length) {
                    for (let i = 0; i < editorArr.length; i++) {
                        if (editorArr[i].dom === 'district_'+index) {
                            editorArr[i].editor.destroy();
                            editorArr[i].editor = null;
                            $('#'+editorArr[i].dom).remove();
                            item.eq(index).remove();
                            editorArr.splice(i, 1);
                        }
                    }
                }
            });*/
        });

        // 机构简介
        UE.getEditor('summary');
        // 村信息
        UE.getEditor('econdevelopment');
        UE.getEditor('resosuperiority');
        // 区信息
        for (var i = $(".layui-elem-field").length - 1; i >= 0; i--) {
            var editor = UE.getEditor('district_'+i);
            editorArr.push( {
                editor: editor,
                dom: 'district_'+i
            } );
        }

    });
</script>
{/block}
